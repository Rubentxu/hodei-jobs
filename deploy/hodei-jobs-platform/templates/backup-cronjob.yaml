{{- if and .Values.backup.enabled .Values.backup.targets.postgresql.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "hodei-jobs-platform.fullname" . }}-backup
  labels:
    {{- include "hodei-jobs-platform.labels" . | nindent 4 }}
  annotations:
    {{- toYaml .Values.serviceMonitor.annotations | nindent 4 }}
spec:
  schedule: {{ .Values.backup.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "hodei-jobs-platform.selectorLabels" . | nindent 12 }}
        spec:
          serviceAccountName: {{ include "hodei-jobs-platform.serviceAccountName" . }}
          restartPolicy: OnFailure
          {{- with .Values.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          containers:
          - name: backup
            image: ghcr.io/rubentxu/hodei-jobs-platform:{{ .Values.image.tag }}
            command: ["/bin/sh", "-c"]
            args:
              - |
                # Wait for database to be ready
                until pg_isready -h {{ include "hodei-jobs-platform.fullname" . }}-postgresql -U postgres; do
                  echo "Waiting for PostgreSQL..."
                  sleep 5
                done

                # Create backup
                TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                BACKUP_FILE="/tmp/backup_${TIMESTAMP}.sql.gz"

                pg_dumpall -h {{ include "hodei-jobs-platform.fullname" . }}-postgresql -U postgres | \
                  gzip > "${BACKUP_FILE}"

                # Upload to S3
                if [ -n "$S3_BUCKET" ]; then
                  aws s3 cp "${BACKUP_FILE}" "s3://${S3_BUCKET}/postgresql/${BACKUP_FILE}.gz" || true
                fi

                # Cleanup local file
                rm -f "${BACKUP_FILE}"

            env:
              - name: S3_BUCKET
                valueFrom:
                  secretKeyRef:
                    name: {{ .Values.backup.storage.secretName | default "backup-credentials" }}
                    key: "bucket"
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    name: {{ .Values.backup.storage.secretName | default "backup-credentials" }}
                    key: "access-key"
              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: {{ .Values.backup.storage.secretName | default "backup-credentials" }}
                    key: "secret-key"
              - name: AWS_DEFAULT_REGION
                value: {{ .Values.backup.storage.region | quote }}
            resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 256Mi
            volumeMounts:
              - name: tmp
                mountPath: /tmp
          volumes:
            - name: tmp
              emptyDir:
                sizeLimit: 1Gi
{{- end }}
