{{- if and .Values.prometheusRules.enabled .Values.serviceMonitor.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "hodei-jobs-platform.fullname" . }}
  labels:
    {{- include "hodei-jobs-platform.labels" . | nindent 4 }}
    {{- if .Values.serviceMonitor.labels }}
    {{- toYaml .Values.serviceMonitor.labels | nindent 4 }}
    {{- end }}
  annotations:
    {{- toYaml .Values.serviceMonitor.annotations | nindent 4 }}
spec:
  groups:
  - name: hodei-jobs-platform
    rules:
    # Platform availability
    - alert: HodeiJobPlatformDown
      expr: up{job="hodei-jobs-platform"} == 0
      for: 5m
      labels:
        severity: critical
        {{- if .Values.serviceMonitor.labels }}
        {{- toYaml .Values.serviceMonitor.labels | nindent 8 }}
        {{- end }}
      annotations:
        summary: "Hodei Jobs Platform is down"
        description: "The Hodei Jobs Platform has been unavailable for more than 5 minutes."

    # Job queue backlog
    - alert: HodeiJobQueueBacklog
      expr: hodei_jobs_queue_depth > 1000
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Job queue backlog is growing"
        description: "Job queue depth is {{ $value }} jobs"

    # High error rate
    - alert: HodeiJobHighErrorRate
      expr: rate(hodei_jobs_failed_total[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High job failure rate detected"
        description: "Job failure rate is {{ $value }} failures/second"

    # Worker availability
    - alert: HodeiWorkersUnavailable
      expr: hodei_workers_available < {{ .Values.autoscaling.minReplicas }}
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Not enough workers available"
        description: "Only {{ $value }} workers available"

    # NATS connection issues
    - alert: HodeiNATSDisconnected
      expr: nats_connections < 1
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "NATS connection lost"
        description: "No active NATS connections"

    # Database connection issues
    - alert: HodeiDatabaseConnectionIssues
      expr: pg_stat_activity_count > 100
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL connection pool nearly exhausted"
        description: "{{ $value }} active connections"

    # Memory pressure
    - alert: HodeiMemoryPressure
      expr: container_memory_usage_bytes{namespace="{{ $.Release.Namespace }}",pod=~"{{ include "hodei-jobs-platform.fullname" $ }}-.*"} > 0.9 * container_spec_memory_limit_bytes{namespace="{{ $.Release.Namespace }}"}
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Container memory usage above 90%"
        description: "Memory usage is {{ $value | humanize1024 }}B"

    # CPU pressure
    - alert: HodeiCPUPressure
      expr: rate(container_cpu_usage_seconds_total{namespace="{{ $.Release.Namespace }}",pod=~"{{ include "hodei-jobs-platform.fullname" $ }}-.*"}[5m]) > 0.9
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Container CPU usage above 90%"
        description: "CPU usage rate is {{ $value }} cores"
{{- end }}
