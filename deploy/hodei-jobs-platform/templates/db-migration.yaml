apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "hodei-jobs-platform.fullname" . }}-migrate
  labels:
    {{- include "hodei-jobs-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: migration
    app.kubernetes.io/part-of: hodei-jobs-platform
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: hook-succeeded,hook-failed
    helm.sh/hook-weight: "10"
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        {{- include "hodei-jobs-platform.labels" . | nindent 8 }}
        app.kubernetes.io/component: migration
        app.kubernetes.io/part-of: hodei-jobs-platform
    spec:
      restartPolicy: Never
      # Wait for dependencies using init container
      initContainers:
      - name: wait-for-dependencies
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          echo "Waiting for PostgreSQL..."
          nc -zv {{ include "hodei-jobs-platform.fullname" . }}-postgresql 5432
          echo "PostgreSQL ready!"
          echo "Waiting for NATS..."
          nc -zv {{ include "hodei-jobs-platform.fullname" . }}-nats 4222
          echo "NATS ready!"
          echo "All dependencies ready!"
        resources:
          limits:
            cpu: 100m
            memory: 64Mi
          requests:
            cpu: 50m
            memory: 32Mi
      containers:
      - name: migrate
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command: ["hodei-jobs-server", "migrate"]
        env:
        - name: SERVER_DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: {{ include "hodei-jobs-platform.fullname" . }}-postgresql
              key: connection-string
        - name: HODEI_NATS_URLS
          value: "nats://{{ include "hodei-jobs-platform.fullname" . }}-nats:4222"
        - name: HODEI_NATS_ENABLED
          value: "1"
        - name: RUST_LOG
          value: {{ .Values.logging.level | default "INFO" }}
        - name: HODEI_JOB_CONTROLLER_ENABLED
          value: "0"
        - name: HODEI_DEV_MODE
          value: "0"
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 256Mi
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 256Mi
      terminationGracePeriodSeconds: 10
