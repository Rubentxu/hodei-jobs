apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "hodei-jobs-platform.fullname" . }}-config
  labels:
    {{- include "hodei-jobs-platform.labels" . | nindent 4 }}
data:
  config.yaml: |
    # =============================================================================
    # Hodei Jobs Platform Configuration
    # =============================================================================
    # Generated by Helm chart - DO NOT EDIT MANUALLY
    # =============================================================================

    server:
      grpc_port: {{ .Values.service.grpcPort }}
      http_port: {{ .Values.service.port }}
      host: "0.0.0.0"
      {{- if .Values.service.annotations }}
      metrics:
        enabled: true
        path: "/metrics"
      {{- end }}

    # =============================================================================
    # NATS JetStream Configuration
    # =============================================================================
    nats:
      enabled: {{ .Values.nats.enabled }}
      urls: {{ printf "nats://%s-nats:4222" (include "hodei-jobs-platform.fullname" .) | quote }}
      {{- if .Values.nats.auth.enabled }}
      auth:
        enabled: true
        type: "basic"  # basic, token, nkeys
      {{- end }}
      {{- if .Values.nats.tls.enabled }}
      tls:
        enabled: true
        ca_file: "/etc/nats/certs/ca.crt"
      {{- end }}
      jetstream:
        enabled: {{ .Values.nats.jetstream.enabled }}
        max_memory_store: {{ .Values.nats.jetstream.maxMemoryStore }}
        max_file_store: {{ .Values.nats.jetstream.maxFileStore }}

    # =============================================================================
    # PostgreSQL Configuration
    # =============================================================================
    database:
      {{- if .Values.postgresql.useInternal }}
      url: "postgresql://postgres:$(POSTGRES_PASSWORD)@{{ include "hodei-jobs-platform.fullname" . }}-postgresql:5432/{{ .Values.postgresql.auth.database }}"
      {{- else if .Values.postgresql.connectionString }}
      url: {{ .Values.postgresql.connectionString | quote }}
      {{- else }}
      url: ""
      {{- end }}
      max_connections: 25
      connection_timeout: 30s

    # =============================================================================
    # Kubernetes Provider
    # =============================================================================
    providers:
      kubernetes:
        {{- if .Values.kubernetesProvider.enabled }}
        enabled: true
        namespace: {{ .Values.kubernetesProvider.namespace }}
        {{- if .Values.kubernetesProvider.kubeconfigPath }}
        kubeconfig_path: {{ .Values.kubernetesProvider.kubeconfigPath | quote }}
        {{- end }}
        {{- if .Values.kubernetesProvider.context }}
        context: {{ .Values.kubernetesProvider.context | quote }}
        {{- end }}
        service_account: {{ .Values.kubernetesProvider.serviceAccount | quote }}
        {{- if .Values.kubernetesProvider.imagePullSecrets }}
        image_pull_secrets: {{ toJson .Values.kubernetesProvider.imagePullSecrets }}
        {{- end }}
        default_resources:
          cpu_request: {{ .Values.kubernetesProvider.defaultCpuRequest | quote }}
          cpu_limit: {{ .Values.kubernetesProvider.defaultCpuLimit | quote }}
          memory_request: {{ .Values.kubernetesProvider.defaultMemoryRequest | quote }}
          memory_limit: {{ .Values.kubernetesProvider.defaultMemoryLimit | quote }}
        pod_security_standard: {{ .Values.kubernetesProvider.podSecurityStandard | quote }}
        enable_hpa: {{ .Values.kubernetesProvider.enableHPA }}
        enable_dynamic_namespaces: {{ .Values.kubernetesProvider.enableDynamicNamespaces }}
        namespace_prefix: {{ .Values.kubernetesProvider.namespacePrefix | quote }}
        max_concurrent_workers: {{ .Values.kubernetesProvider.maxConcurrentWorkers }}
        worker_lifecycle:
          idle_timeout: {{ .Values.kubernetesProvider.workerLifecycle.idleTimeout | quote }}
          max_lifetime: {{ .Values.kubernetesProvider.workerLifecycle.maxLifetime | quote }}
          graceful_termination: {{ .Values.kubernetesProvider.workerLifecycle.gracefulTermination | quote }}
        {{- else }}
        enabled: false
        {{- end }}

      docker:
        {{- if .Values.dockerProvider.enabled }}
        enabled: true
        host: {{ .Values.dockerProvider.host | quote }}
        network: {{ .Values.dockerProvider.network | quote }}
        {{- if .Values.dockerProvider.tls.enabled }}
        tls:
          enabled: true
          ca_cert: {{ .Values.dockerProvider.tls.caCert | quote }}
          client_cert: {{ .Values.dockerProvider.tls.clientCert | quote }}
          client_key: {{ .Values.dockerProvider.tls.clientKey | quote }}
        {{- end }}
        {{- else }}
        enabled: false
        {{- end }}

    # =============================================================================
    # Job Execution Configuration
    # =============================================================================
    job_execution:
      max_concurrent_jobs: {{ .Values.jobExecution.maxConcurrentJobs | default 10 }}
      default_timeout: {{ .Values.jobExecution.defaultTimeout | default "1h" }}
      max_retries: {{ .Values.jobExecution.maxRetries | default 3 }}
      retry_backoff:
        initial: {{ .Values.jobExecution.retryBackoff.initial | default "1s" }}
        max: {{ .Values.jobExecution.retryBackoff.max | default "5m" }}
        multiplier: {{ .Values.jobExecution.retryBackoff.multiplier | default 2.0 }}
      cleanup:
        enabled: {{ .Values.jobExecution.cleanup.enabled }}
        after_completion: {{ .Values.jobExecution.cleanup.afterCompletion | default "5m" }}
        failed_jobs_retention: {{ .Values.jobExecution.cleanup.failedJobsRetention | default "24h" }}
        succeeded_jobs_retention: {{ .Values.jobExecution.cleanup.succeededJobsRetention | default "7d" }}

    # =============================================================================
    # Logging Configuration
    # =============================================================================
    logging:
      level: {{ .Values.logging.level | default "INFO" }}
      format: {{ .Values.logging.format | default "json" }}
      output: {{ .Values.logging.output | default "stdout" }}
      {{- if .Values.logging.external.enabled }}
      external:
        enabled: true
        type: {{ .Values.logging.external.type | default "loki" }}
        endpoint: {{ .Values.logging.external.endpoint | quote }}
        batch_size: {{ .Values.logging.external.batchSize | default 1000 }}
        batch_timeout: {{ .Values.logging.external.batchTimeout | default "5s" }}
      {{- end }}

    # =============================================================================
    # Metrics Configuration
    # =============================================================================
    metrics:
      enabled: true
      port: {{ .Values.service.port }}
      path: {{ .Values.serviceMonitor.path | default "/metrics" }}

    # =============================================================================
    # Tracing Configuration
    # =============================================================================
    tracing:
      enabled: {{ .Values.tracing.enabled }}
      exporter: {{ .Values.tracing.exporter | default "otlp" }}
      endpoint: {{ .Values.tracing.endpoint | quote }}
      sample_rate: {{ .Values.tracing.sampleRate | default 1.0 }}
      propagation: {{ .Values.tracing.propagation | default "w3c" }}

    # =============================================================================
    # Worker Configuration
    # =============================================================================
    worker:
      image: "{{ .Values.workerImage.repository }}:{{ .Values.workerImage.tag | default "latest" }}"
      {{- if .Values.dockerProvider.enabled }}
      docker:
        enabled: true
        network: {{ .Values.dockerProvider.network | quote }}
      {{- end }}
      {{- if .Values.kubernetesProvider.enabled }}
      kubernetes:
        enabled: true
        namespace: {{ .Values.kubernetesProvider.namespace }}
      {{- end }}

    # =============================================================================
    # Backup Configuration
    # =============================================================================
    backup:
      enabled: {{ .Values.backup.enabled }}
      schedule: {{ .Values.backup.schedule | quote }}
      retention: {{ .Values.backup.retention | quote }}
      storage:
        type: {{ .Values.backup.storage.type | default "s3" }}
        bucket: {{ .Values.backup.storage.bucket | quote }}
        region: {{ .Values.backup.storage.region | quote }}
        {{- if .Values.backup.storage.endpoint }}
        endpoint: {{ .Values.backup.storage.endpoint | quote }}
        {{- end }}
