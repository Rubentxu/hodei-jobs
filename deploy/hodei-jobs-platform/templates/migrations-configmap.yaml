{{- /*
  ConfigMap generator for database migrations.
  Migrations are sourced from the code at:
  crates/server/infrastructure/src/persistence/postgres/migrations/

  ONLY used in production mode.
  In development, DevSpace syncs migrations directly to the pod.

  Helm mounts these ConfigMaps in:
    - /app/migrations (core migrations)
    - /app/infrastructure-migrations (infra migrations)
*/ -}}

{{- if not .Values.development.enabled }}

{{- $migrationsCorePath := "crates/server/infrastructure/src/persistence/postgres/migrations/core" }}
{{- $migrationsInfraPath := "crates/server/infrastructure/src/persistence/postgres/migrations/infra" }}

{{- $files := $.Files }}

{{- if $files.Match $migrationsCorePath "*.sql" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "hodei-jobs-platform.fullname" . }}-migrations
  labels:
    {{- include "hodei-jobs-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: migrations
    app.kubernetes.io/part-of: hodei-jobs-platform
data:
{{- range $path := $files.Match $migrationsCorePath "*.sql" }}
{{ $name := $path | base }}
  {{ $name }}: |
    {{- $files.Get $path | nindent 4 }}
{{- end }}
{{- end }}

{{- if $files.Match $migrationsInfraPath "*.sql" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "hodei-jobs-platform.fullname" . }}-migrations-infra
  labels:
    {{- include "hodei-jobs-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: migrations-infra
    app.kubernetes.io/part-of: hodei-jobs-platform
data:
{{- range $path := $files.Match $migrationsInfraPath "*.sql" }}
{{ $name := $path | base }}
  {{ $name }}: |
    {{- $files.Get $path | nindent 4 }}
{{- end }}
{{- end }}

{{- end }}
