version: v2beta1

name: hodei-jobs

pipelines:
  dev:
    run: |-
      create_deployments --all
      start_dev app

deployments:
  hodei:
    updateImageTags: true
    helm:
      chart:
        name: ./deploy/hodei-jobs-platform
      values:
        image:
          repository: registry.local:31500/hodei-jobs-server
          tag: "dev"
          pullPolicy: Never
        resources:
          limits:
            cpu: "8"
            memory: "12Gi"
          requests:
            cpu: "6"
            memory: "8Gi"
        development:
          enabled: true
          devspace:
            enabled: true
        volumes:
          extra:
            - name: cargo-cache
              persistentVolumeClaim:
                claimName: hodei-cargo-cache
        volumeMounts:
          - name: cargo-cache
            mountPath: /root/.cargo/registry
      valuesFiles:
        - ./deploy/hodei-jobs-platform/values.yaml
        - ./deploy/hodei-jobs-platform/values-dev.yaml

dev:
  app:
    devImage: 10.43.54.80:5000/hodei-jobs-server:dev

    labelSelector:
      app.kubernetes.io/name: hodei-jobs-platform
      app.kubernetes.io/component: server

    # Sync ONLY source code - exclude everything else
    sync:
      - path: ./crates:/app/crates
        excludePaths:
          - target/**
          - "**/*_test.rs"
          - "**/tests/**"
      - path: ./proto:/app/proto
      - path: ./scripts:/app/scripts
      - path: ./Cargo.toml:/app/Cargo.toml
      - path: ./Cargo.lock:/app/Cargo.lock

    # Port forwarding
    ports:
      - port: 9090:9090

    # Log streaming
    logs:
      enabled: true

    # Terminal - starts server with hot reload
    terminal:
      command: /app/scripts/devspace-start.sh
