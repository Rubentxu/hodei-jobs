version: v2

name: hodei-jobs

# =============================================================================
# DESARROLLO RÃPIDO RUST + MINIKUBE CON DEVSPACE
# =============================================================================
# Flujo optimizado:
# 1. Compila Rust localmente: cargo build -p hodei-server-bin
# 2. DevSpace sincroniza el binario al pod
# 3. Reinicio del proceso (no contenedor) con seÃ±al USR1
#
# Tiempo de reload: ~2-5 segundos (solo sincronizaciÃ³n de binario)
# Sin rebuild de imagen Docker
# =============================================================================

config:
  activation:
    - command: dev
      profile: minikube
    - command: minikube
      profile: minikube

profiles:
  # Perfil para desarrollo en Minikube
  - name: minikube
    patches:
      - op: replace
        path: dev.env
        value:
          - name: RUST_LOG
            value: debug
          - name: HODEI_DEV_MODE
            value: "1"

# =============================================================================
# DESARROLLO
# =============================================================================
dev:
  # Imagen base (solo para entorno, el proceso se reemplaza)
  imageSelector: localhost:5000/hodei-jobs-server:latest

  # Terminal interactiva
  terminal:
    command: |
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘         HODEI JOBS - DESARROLLO RÃPIDO RUST                    â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "ðŸ“¦ FLUJO DE DESARROLLO:"
      echo "   1. Compila localmente: cargo build -p hodei-server-bin"
      echo "   2. El binario se sincroniza automÃ¡ticamente"
      echo "   3. Reinicia el proceso: kill -USR1 \$(cat /tmp/server.pid)"
      echo ""
      echo "ðŸ“ O usa el comando: devspace restart-process"
      echo ""
      echo "ðŸ’¡ El binario en target/debug/hodei-server-bin â†’ /tmp/server-bin"
      echo ""

      # Script de gestiÃ³n del servidor
      start_server() {
        if [ -f /tmp/server-bin ]; then
          cp /tmp/server-bin /usr/local/bin/hodei-server-bin
          chmod +x /usr/local/bin/hodei-server-bin
          echo "ðŸš€ Iniciando hodei-server..."
          /usr/local/bin/hodei-server-bin &
          echo $! > /tmp/server.pid
          echo "âœ… Servidor iniciado (PID: $(cat /tmp/server.pid))"
        else
          echo "âš ï¸  Binario no encontrado. Compila con: cargo build -p hodei-server-bin"
        fi
      }

      # Manejador de seÃ±al USR1 para hot reload
      handle_reload() {
        echo ""
        echo "ðŸ”„ ðŸ”„ ðŸ”„ RECARGANDO ðŸ”„ ðŸ”„ ðŸ”„"
        if [ -f /tmp/server.pid ]; then
          PID=$(cat /tmp/server.pid)
          if kill -0 $PID 2>/dev/null; then
            echo "ðŸ›‘ Deteniendo servidor (PID: $PID)..."
            kill $PID 2>/dev/null || true
            sleep 1
          fi
        fi
        start_server
      }

      trap 'handle_reload' USR1

      # Iniciar servidor inicial
      start_server

      # Loop de supervisiÃ³n
      while true; do
        sleep 5

        # Verificar si el proceso sigue vivo
        if [ -f /tmp/server.pid ]; then
          PID=$(cat /tmp/server.pid)
          if ! kill -0 $PID 2>/dev/null; then
            echo "âš ï¸  Servidor muriÃ³, reiniciando..."
            start_server
          fi
        fi
      done
    workDir: /app

  # =============================================================================
  # SINCRONIZACIÃ“N DE BINARIO ( bidireccional )
  # =============================================================================
  sync:
    # Sincronizar binario compilado al pod
    - localPath: target/debug/hodei-server-bin
      remotePath: /tmp/server-bin
      fileMode: 493 # 0755
      downloadExclude: []
      uploadExclude: []
      # NO restartContainer - usamos seÃ±al USR1 manualmente

    # Sincronizar cÃ³digo fuente (para debugging/editor)
    - localPath: crates/
      remotePath: /app/crates/
      downloadExclude:
        - "**/target/**"
      uploadExclude:
        - "**/target/**"

    # Sincronizar proto files
    - localPath: proto/
      remotePath: /app/proto/

  # =============================================================================
  # REINICIO DE PROCESO (no contenedor)
  # =============================================================================
  # Comandos ejecutados despuÃ©s de sincronizar archivos
  onUpload:
    exec:
      # Este comando se ejecuta en el contenedor despuÃ©s de cada sync
      - name: notify-reload
        command: |
          # Solo notificar, no reiniciar automÃ¡ticamente
          # El usuario debe enviar seÃ±al USR1 manualmente o usar devspace restart-process
          true
        failOnError: false
        once: false

  # =============================================================================
  # PUERTOS
  # =============================================================================
  ports:
    - port: 9090
      localPort: 9090
      name: gRPC Server
      bindAddress: "0.0.0.0"

  # =============================================================================
  # VARIABLES DE ENTORNO
  # =============================================================================
  env:
    - name: RUST_LOG
      value: debug
    - name: HODEI_DEV_MODE
      value: "1"
    - name: SERVER_DATABASE_URL
      value: postgres://postgres:postgres@hodei-postgresql.hodei-jobs.svc.cluster.local:5432/hodei_jobs
    - name: HODEI_NATS_URLS
      value: nats://hodei-nats.hodei-jobs.svc.cluster.local:4222
    - name: HODEI_K8S_ENABLED
      value: "1"
    - name: HODEI_DOCKER_ENABLED
      value: "0"
    - name: HODEI_MIGRATIONS_PATH
      value: /app/migrations,/app/infrastructure-migrations

# =============================================================================
# DEPLOYMENT (Helm)
# =============================================================================
deployments:
  - name: hodei
    helm:
      chart:
        name: ./deploy/hodei-jobs-platform
      release:
        name: hodei
        namespace: hodei-jobs
      valuesFiles:
        - ./deploy/hodei-jobs-platform/values-dev.yaml
      values:
        image:
          repository: localhost:5000/hodei-jobs-server
          tag: latest
          pullPolicy: Never

# =============================================================================
# COMANDOS PERSONALIZADOS
# =============================================================================
commands:
  # Compilar y empezar desarrollo
  - name: dev
    command: |
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘         COMPILANDO RUST + INICIANDO DEVSPACE                  â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""

      # Compilar Rust
      echo "ðŸ”¨ Compilando hodei-server-bin..."
      cargo build -p hodei-server-bin 2>&1 | tail -10

      if [ ${PIPESTATUS[0]} -eq 0 ]; then
        echo ""
        echo "âœ… CompilaciÃ³n exitosa!"
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         Â¡LISTO PARA DESARROLLO!                               â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ðŸš€ Ejecuta: devspace dev"
        echo ""
        echo "En la terminal del pod:"
        echo "  1. El servidor arrancarÃ¡ automÃ¡ticamente"
        echo "  2. Cuando quieras recargar:"
        echo "     kill -USR1 \$(cat /tmp/server.pid)"
        echo ""
        echo "O desde otra terminal local:"
        echo "  devspace restart-process"
      else
        echo "âŒ Error en compilaciÃ³n"
        exit 1
      fi
    description: Compile and prepare for dev mode

  # Reiniciar solo el proceso (no el contenedor)
  - name: restart-process
    command: |
      echo "ðŸ”„ Reiniciando proceso del servidor..."
      # Enviar seÃ±al USR1 al proceso del servidor
      kubectl exec -n hodei-jobs -l app.kubernetes.io/name=hodei-jobs-platform -- \
        sh -c 'kill -USR1 $(cat /tmp/server.pid 2>/dev/null)' 2>/dev/null || \
        echo "âš ï¸  No se pudo reiniciar. AsegÃºrate de que devspace dev estÃ© ejecutÃ¡ndose."
      echo "âœ… SeÃ±al USR1 enviada"
    description: Restart server process (not container)

  # Ver estado del servidor en el pod
  - name: status
    command: |
      echo "=== Pods ==="
      kubectl get pods -n hodei-jobs -l app.kubernetes.io/name=hodei-jobs-platform
      echo ""
      echo "=== Proceso del servidor ==="
      kubectl exec -n hodei-jobs -l app.kubernetes.io/name=hodei-jobs-platform -- \
        sh -c 'cat /tmp/server.pid 2>/dev/null && ps aux | grep hodei-server || echo "No encontrado"' 2>/dev/null || echo "Pod no disponible"
    description: Show server status in pod

  # Ver logs del servidor
  - name: logs
    command: |
      kubectl logs -n hodei-jobs -l app.kubernetes.io/name=hodei-jobs-platform --follow --tail=100
    description: Stream server logs

  # Solo sincronizaciÃ³n
  - name: sync
    command: devspace sync
    description: Start file sync only

  # Deploy completo (para producciÃ³n)
  - name: deploy
    command: |
      echo "=== Compilando (release) ==="
      cargo build --release -p hodei-server-bin

      echo ""
      echo "=== Build imagen Docker ==="
      docker build -f Dockerfile.server -t localhost:5000/hodei-jobs-server:latest --load .

      echo ""
      echo "=== Cargando a minikube ==="
      minikube image load localhost:5000/hodei-jobs-server:latest

      echo ""
      echo "=== Deploy Helm ==="
      helm upgrade --install hodei ./deploy/hodei-jobs-platform \
        -n hodei-jobs \
        -f ./deploy/hodei-jobs-platform/values-dev.yaml \
        --wait --timeout 5m

      echo ""
      echo "=== Logs ==="
      kubectl logs -n hodei-jobs -l app.kubernetes.io/name=hodei-jobs-platform -f
    description: Full build and deploy

  # Puerto forwarding
  - name: port-forward
    command: |
      kubectl port-forward -n hodei-jobs svc/hodei-hodei-jobs-platform 9090:9090
    description: Port forward to gRPC server

  # Uninstall
  - name: uninstall
    command: |
      helm uninstall hodei -n hodei-jobs 2>/dev/null
      kubectl delete namespace hodei-jobs hodei-jobs-workers 2>/dev/null || true
      echo "âœ… Desinstalado"
    description: Remove deployment

vars:
  - name: VERSION
    value: ${VERSION:-latest}
