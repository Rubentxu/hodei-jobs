version: v2

name: hodei-jobs

config:
  activation:
    - command: dev
      profile: development
    - command: minikube
      profile: minikube-local
    - command: deploy
      profile: deployment

profiles:
  # Desarrollo local (PostgreSQL + NATS externos requeridos)
  - name: development
    patches:
      - op: replace
        path: dev.env
        value:
          - name: RUST_LOG
            value: info,hodei_server=debug
          - name: HODEI_DEV_MODE
            value: "1"
          - name: SERVER_DATABASE_URL
            value: postgres://postgres:postgres@localhost:5432/hodei_jobs
          - name: HODEI_NATS_URLS
            value: nats://localhost:4222
          - name: HODEI_SERVER_GRPC_PORT
            value: "50051"
          - name: HODEI_K8S_ENABLED
            value: "0"
          - name: HODEI_DOCKER_ENABLED
            value: "1"
      - op: replace
        path: dev.terminal.command
        value: cargo run -p hodei-server-bin

  # Desarrollo con Minikube + Helm (full K8s stack)
  - name: minikube-local
    patches:
      - op: replace
        path: dev.env
        value:
          - name: RUST_LOG
            value: debug,hodei_server=info
          - name: HODEI_DEV_MODE
            value: "1"
          - name: SERVER_DATABASE_URL
            value: postgres://postgres:postgres@hodei-postgresql.hodei-jobs.svc.cluster.local:5432/hodei_jobs
          - name: HODEI_NATS_URLS
            value: nats://hodei-nats.hodei-jobs.svc.cluster.local:4222
          - name: HODEI_SERVER_GRPC_PORT
            value: "50051"
          - name: HODEI_K8S_ENABLED
            value: "1"
          - name: HODEI_DOCKER_ENABLED
            value: "0"
          - name: HODEI_K8S_NAMESPACE
            value: hodei-jobs-workers
      - op: remove
        path: dev.terminal

  # Despliegue a K8s con Helm (sin desarrollo)
  - name: deployment
    patches:
      - op: remove
        path: dev

# Desarrollo local (cargo run + sync)
dev:
  hotReload: false # Rust no necesita hot-reload, cargo run es suficiente
  workDir: /app

  sync:
    - localPath: .
      remotePath: /app
      file: false
      excludePaths:
        - .git
        - target
        - Cargo.lock
        - logs
        - .claude
        - "**/*.log"
        - "*.tmp"
        - "**/target"
        - "**/Cargo.lock"

  ports:
    - port: 50051
      localPort: 50051
      name: gRPC Server
      bindAddress: "127.0.0.1"

  env:
    - name: RUST_LOG
      value: info,hodei_server=debug
    - name: HODEI_DEV_MODE
      value: "1"
    - name: RUST_BACKTRACE
      value: "1"

  terminal:
    command: cargo run -p hodei-server-bin
    workDir: /app

  autoReload:
    paths:
      - ./crates/**/src/**/*.rs
      - ./proto/**/*.proto
      - ./Cargo.toml

# Imágenes para build/push
images:
  server:
    image: ghcr.io/rubentxu/hodei-jobs/server:${VERSION:-latest}
    dockerfile: Dockerfile
    context: .

  worker:
    image: ghcr.io/rubentxu/hodei-jobs/worker:${VERSION:-latest}
    dockerfile: Dockerfile.worker
    context: .

# Deployment con Helm
deployments:
  - name: hodei
    helm:
      chart:
        name: ./deploy/hodei-jobs-platform
      release:
        name: hodei
        namespace: hodei-jobs
      valuesFiles:
        - ./deploy/hodei-jobs-platform/values-dev.yaml
      values:
        image:
          repository: ${IMAGE_REPO:-ghcr.io/rubentxu/hodei-jobs}
          tag: ${VERSION:-latest}

# Comandos
commands:
  # Desarrollo local (requiere PostgreSQL + NATS local)
  - name: start
    command: dev
    description: Start development with cargo run (requires PostgreSQL & NATS on localhost:5432, :4222)
    aliases: [run, up, dev]

  # Desarrollo con Minikube (usa Helm + K8s servicios)
  - name: minikube
    command: dev --profile minikube-local
    description: Start with Minikube + Helm (full K8s stack with PostgreSQL, NATS in K8s)
    aliases: [mk, k8s]

  # Build images
  - name: build
    command: build
    description: Build server and worker images
    flags:
      - name: push
        description: Push images to registry after build
      - name: platform
        description: Target platform (linux/amd64)

  # Build worker image only
  - name: build-worker
    command: "build --image worker --push"
    description: Build and push worker image

  # Deploy a K8s con Helm
  - name: deploy
    command: |
      echo "Deploying Hodei to K8s with Helm..."
      helm upgrade --install hodei ./deploy/hodei-jobs-platform \
        -n hodei-jobs \
        --create-namespace \
        -f ./deploy/hodei-jobs-platform/values-dev.yaml \
        --set image.repository=${IMAGE_REPO:-ghcr.io/rubentxu/hodei-jobs} \
        --set image.tag=${VERSION:-latest} \
        --wait --timeout 5m
      echo "Deployment complete!"
      echo "Check status: kubectl get pods -n hodei-jobs"
    description: Deploy to K8s with Helm
    aliases: [install, up]

  # Upgrade deployment (después de rebuild)
  - name: upgrade
    command: |
      echo "Upgrading Hodei..."
      helm upgrade hodei ./deploy/hodei-jobs-platform \
        -n hodei-jobs \
        -f ./deploy/hodei-jobs-platform/values-dev.yaml \
        --set image.tag=${VERSION:-latest} \
        --wait --timeout 5m
      kubectl rollout status deployment/hodei-hodei-jobs-platform -n hodei-jobs
    description: Upgrade existing deployment
    aliases: [update]

  # Ver estado
  - name: status
    command: |
      echo "=== Hodei Deployment Status ==="
      kubectl get pods -n hodei-jobs
      echo ""
      echo "=== Services ==="
      kubectl get svc -n hodei-jobs
    description: Show deployment status
    container: false

  # Ver logs
  - name: logs
    command: |
      kubectl logs -n hodei-jobs -l app.kubernetes.io/name=hodei-jobs-platform --follow --tail=100
    description: Show logs from server
    flags:
      - name: tail
        shorthand: t
        description: Number of lines

  # Ver logs de workers
  - name: logs-workers
    command: |
      kubectl logs -n hodei-jobs-workers -l app.kubernetes.io/name=hodei-worker --follow
    description: Show logs from workers

  # Puerto forwarding al server
  - name: port-forward
    command: |
      kubectl port-forward -n hodei-jobs svc/hodei-hodei-jobs-platform 50051:50051 &
      echo "Port forward started on localhost:50051"
      fg
    description: Create port-forward to gRPC server
    aliases: [pf]

  # Renderizar YAML sin aplicar
  - name: render
    command: |
      helm template hodei ./deploy/hodei-jobs-platform \
        -n hodei-jobs \
        -f ./deploy/hodei-jobs-platform/values-dev.yaml
    description: Render Helm templates without applying

  # Uninstall
  - name: uninstall
    command: |
      echo "Uninstalling Hodei..."
      helm uninstall hodei -n hodei-jobs
      kubectl delete namespace hodei-jobs hodei-jobs-workers 2>/dev/null || true
    description: Remove deployment from K8s
    aliases: [down, delete]

  # Ver eventos
  - name: events
    command: |
      kubectl get events -n hodei-jobs --sort-by='.lastTimestamp' | tail -30
    description: Show recent events

  # Verificar health
  - name: health
    command: |
      echo "=== Pods ==="
      kubectl get pods -n hodei-jobs
      echo ""
      echo "=== NATS JetStream ==="
      kubectl exec -n hodei-jobs hodei-nats-0 -- nats server jetstream show 2>/dev/null || echo "NATS not ready"
      echo ""
      echo "=== Database ==="
      kubectl exec -n hodei-jobs hodei-postgresql-0 -- pg_isready -U postgres 2>/dev/null || echo "PostgreSQL not ready"
    description: Check deployment health
    aliases: [check]

# Variables
vars:
  - name: VERSION
    value: ${VERSION:-latest}
  - name: IMAGE_REPO
    value: ${IMAGE_REPO:-ghcr.io/rubentxu/hodei-jobs}
