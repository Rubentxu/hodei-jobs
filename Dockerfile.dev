# Download pre-built sccache binary
FROM ubuntu:22.04 AS downloader

RUN apt-get update && apt-get install -y wget tar && rm -rf /var/lib/apt/lists/*

# Download sccache binary for x86_64-unknown-linux-musl
ENV SCCACHE_VERSION="0.7.7"
RUN wget -q https://github.com/mozilla/sccache/releases/download/v${SCCACHE_VERSION}/sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl.tar.gz && \
    tar -xzf sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl.tar.gz && \
    mv sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl/sccache /usr/local/bin/ && \
    rm -rf sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl*

# =============================================================================
FROM ubuntu:22.04

# Copy sccache from downloader
COPY --from=downloader /usr/local/bin/sccache /usr/local/bin/sccache

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    pkg-config \
    libssl-dev \
    ca-certificates \
    git \
    inotify-tools \
    jq \
    protobuf-compiler \
    clang \
    lld \
    && rm -rf /var/lib/apt/lists/*

# Install Rust (minimal toolchain for in-pod compilation if needed)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile minimal

# Add Rust to PATH
ENV PATH="/root/.cargo/bin:${PATH}"

# Configure Cargo for fast linking with lld and incremental compilation
RUN mkdir -p /root/.cargo && \
    echo '[build]' > /root/.cargo/config.toml && \
    echo 'rustflags = ["-C", "linker=clang", "-C", "link-arg=-fuse-ld=lld"]' >> /root/.cargo/config.toml && \
    echo '' >> /root/.cargo/config.toml && \
    echo '[profile.dev]' >> /root/.cargo/config.toml && \
    echo 'opt-level = 1' >> /root/.cargo/config.toml && \
    echo 'incremental = true' >> /root/.cargo/config.toml && \
    echo '' >> /root/.cargo/config.toml && \
    echo '[profile.release]' >> /root/.cargo/config.toml && \
    echo 'opt-level = 3' >> /root/.cargo/config.toml && \
    echo 'lto = "thin"' >> /root/.cargo/config.toml && \
    echo 'codegen-units = 4' >> /root/.cargo/config.toml

# Create directories
WORKDIR /app
RUN mkdir -p /var/lib/hodei /tmp/hodei-logs /tmp/server-bin

# Copy entrypoint script
COPY scripts/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment for development - enable incremental compilation
ENV HODEI_MIGRATIONS_PATH=/app/migrations
ENV RUST_LOG=info
ENV CARGO_NET_GIT_FETCH_WITH_CLI=false
ENV CARGO_INCREMENTAL=1

EXPOSE 9090

ENTRYPOINT ["/entrypoint.sh"]
