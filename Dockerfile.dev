# DevSpace Development Image - Includes Rust toolchain for in-pod compilation
FROM ubuntu:22.04

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    pkg-config \
    libssl-dev \
    ca-certificates \
    git \
    inotify-tools \
    jq \
    protobuf-compiler \
    clang \
    lld \
    && rm -rf /var/lib/apt/lists/*

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile minimal

# Add Rust to PATH
ENV PATH="/root/.cargo/bin:${PATH}"

# Install cargo-watch for hot reload
RUN cargo install cargo-watch

# Configure Cargo for fast linking with lld and incremental compilation
RUN mkdir -p /root/.cargo && \
    echo '[build]' > /root/.cargo/config.toml && \
    echo 'rustflags = ["-C", "linker=clang", "-C", "link-arg=-fuse-ld=lld"]' >> /root/.cargo/config.toml && \
    echo '' >> /root/.cargo/config.toml && \
    echo '[profile.dev]' >> /root/.cargo/config.toml && \
    echo 'opt-level = 1' >> /root/.cargo/config.toml && \
    echo 'incremental = true' >> /root/.cargo/config.toml && \
    echo '' >> /root/.cargo/config.toml && \
    echo '[profile.release]' >> /root/.cargo/config.toml && \
    echo 'opt-level = 3' >> /root/.cargo/config.toml && \
    echo 'lto = "thin"' >> /root/.cargo/config.toml && \
    echo 'codegen-units = 4' >> /root/.cargo/config.toml

# Create directories
WORKDIR /app
RUN mkdir -p /var/lib/hodei /tmp/hodei-logs /tmp/server-bin

# Copy entrypoint script
COPY scripts/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Environment for development - enable incremental compilation
ENV HODEI_MIGRATIONS_PATH=/app/migrations
ENV RUST_LOG=info
ENV CARGO_NET_GIT_FETCH_WITH_CLI=false
ENV CARGO_INCREMENTAL=1

EXPOSE 9090

ENTRYPOINT ["/entrypoint.sh"]
