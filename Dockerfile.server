# The actual binary is synced by DevSpace to /tmp/server-bin
# This image provides the runtime environment
FROM ubuntu:24.04

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3t64 \
    && rm -rf /var/lib/apt/lists/*

# Create directories
WORKDIR /app
RUN mkdir -p /var/lib/hodei /tmp/hodei-logs /tmp/server-bin

# Create entrypoint script that waits for binary sync
COPY <<'EOF' /entrypoint.sh
#!/bin/bash
set -e

SERVER_BIN="/usr/local/bin/hodei-jobs-server"
SYNC_DIR="/tmp/server-bin"
PID_FILE="/tmp/server.pid"




echo "â³ Waiting for binary sync..."
while [ ! -f "$SYNC_DIR" ]; do
    sleep 1
done

echo "âœ… Binary synced!"

# Copy and make executable
cp "$SYNC_DIR" "$SERVER_BIN"
chmod +x "$SERVER_BIN"

# Write PID for reload support
echo $$ > "$PID_FILE"

echo "ðŸ“¦ Binary info:"
ls -la "$SERVER_BIN"
file "$SERVER_BIN"

echo ""
echo "ðŸš€ Starting server..."
exec "$SERVER_BIN"
EOF

RUN chmod +x /entrypoint.sh && \
    useradd -r -u 2000 -g root -d /var/lib/hodei hodei && \
    chown -R hodei:root /var/lib/hodei

USER hodei

# Environment variables
ENV HODEI_MIGRATIONS_PATH=/app/migrations
ENV RUST_LOG=info

# Expose gRPC port
EXPOSE 9090

# Entry point with binary sync handling
ENTRYPOINT ["/entrypoint.sh"]
