# =============================================================================
# Hodei Jobs Platform - Development Docker Compose
# =============================================================================
# Optimized for rapid development with debugging and fast iteration
#
# Usage:
#   docker compose -f docker-compose.dev.yml up -d postgres
#   docker compose -f docker-compose.dev.yml up -d
#   docker compose -f docker-compose.dev.yml logs -f
#
# Key fixes:
#   - HODEI_SERVER_HOST: Correctly set for worker→server connectivity
#   - Worker network: Separate bridge for worker communication
#   - Health checks: Proper startup sequencing
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL Database (Development)
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: hodei-jobs-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: hodei_jobs
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d hodei_jobs"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - hodei-internal
    deploy:
      resources:
        limits:
          memory: 512M

  # ===========================================================================
  # NATS JetStream (Production-Ready Event Bus)
  # ===========================================================================
  nats:
    image: nats:2.10-alpine
    container_name: hodei-jobs-nats
    restart: unless-stopped
    command:
      - --jetstream
      - -sd
      - /data
    ports:
      - "4222:4222" # Client connections
      - "8222:8222" # HTTP monitoring
    volumes:
      - nats_dev_data:/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "nats-rply -s localhost:4222 'PING' 'PONG' 2>/dev/null || wget -q --spider http://localhost:8222/healthz",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - hodei-internal
    deploy:
      resources:
        limits:
          memory: 256M

  # # ===========================================================================
  # # Hodei gRPC Server (Backend API) - Development
  # # ===========================================================================
  # api:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   image: hodei-jobs-server:dev
  #   container_name: hodei-jobs-api
  #   restart: unless-stopped
  #   environment:
  #     # Database
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: postgres
  #     SERVER_DATABASE_URL: postgres://postgres:postgres@postgres:5432/hodei_jobs

  #     # Server configuration
  #     HODEI_DEV_MODE: "1"
  #     GRPC_PORT: "50051"

  #     # Docker provider
  #     HODEI_DOCKER_ENABLED: "1"
  #     HODEI_DOCKER_NETWORK: "hodei-workers"

  #     # Worker connectivity - CRITICAL for worker→server communication
  #     # Workers use this to connect back to the server
  #     # HODEI_SERVER_HOST: Used by server for provisioning config
  #     # HODEI_SERVER_ADDRESS: Set by providers in worker environment
  #     HODEI_SERVER_HOST: "0.0.0.0"
  #     HODEI_SERVER_ADDRESS: "host.docker.internal"

  #     # Job controller
  #     HODEI_JOB_CONTROLLER_ENABLED: "1"
  #     HODEI_JOB_CONTROLLER_INTERVAL_MS: "500"

  #     # Worker image for provisioning
  #     HODEI_WORKER_IMAGE: "hodei-jobs-worker:latest"

  #     # NATS Event Bus Configuration (Production-Ready Event-Driven)
  #     HODEI_NATS_ENABLED: "1"
  #     HODEI_NATS_URLS: "nats://nats:4222"

  #     # Logging
  #     RUST_LOG: ${RUST_LOG:-debug}
  #   ports:
  #     - "50051:50051"
  #   volumes:
  #     # Docker socket for worker provisioning
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     nats:
  #       condition: service_healthy
  #   healthcheck:
  #     test:
  #       [
  #         "CMD-SHELL",
  #         "wget --no-verbose --tries=1 --spider http://localhost:50051/health || exit 1",
  #       ]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 15s
  #   networks:
  #     - hodei-internal
  #     - hodei-workers
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 1G

# Named volumes for persistent development data
volumes:
  postgres_dev_data:
    driver: local
  nats_dev_data:
    driver: local

# Development networks
networks:
  hodei-internal:
    driver: bridge
  hodei-workers:
    driver: bridge
    name: hodei-workers-dev
    ipam:
      config:
        - subnet: 172.28.0.0/16
